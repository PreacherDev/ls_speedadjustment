local materials = {
    [0]             = 'None',
    [3929336056]    = 'MetalSolidMedium',
    [3985845843]    = 'Woodchips',
    [126470059]     = 'WoodSolidPolished',
    [909950165]     = 'SandWet',
    [3660485991]    = 'Oil',
    [2379541433]    = 'TreeBark',
    [2552123904]    = 'WoodHighDensity',
    [1354180827]    = 'Fiberglass',
    [4201905313]    = 'CarMetal',
    [3938260814]    = 'GravelDeep',
    [474149820]     = 'Paper',
    [2372680412]    = 'Spine0',
    [2901304848]    = 'Temp05',
    [815762359]     = 'WoodSolidLarge',
    [999829011]     = 'Puddle',
    [3381615457]    = 'Twigs',
    [602884284]     = 'CarGlassMedium',
    [1666473731]    = 'PhysNoFriction',
    [513061559]     = 'CarGlassOpaque',
    [1457572381]    = 'Spine2',
    [2128369009]    = 'GravelLarge',
    [1849540536]    = 'MetalHollowMedium',
    [2668971817]    = 'PlasticHighDensity',
    [3929491133]    = 'WoodHollowMedium',
    [1619704960]    = 'SnowDeep',
    [1343679702]    = 'Temp08',
    [1993976879]    = 'WoodHollowSmall',
    [3454750755]    = 'Rock',
    [2825350831]    = 'ClavicleLeft',
    [483400232]     = 'Buttocks',
    [113101985]     = 'HandLeft',
    [2849806867]    = 'DriedMeat',
    [1070994698]    = 'CarGlassStrong',
    [3546625734]    = 'PhysPoolTableBall',
    [3724496396]    = 'Leather',
    [3652308448]    = 'Tarpaulin',
    [509508168]     = 'SandDryDeep',
    [1144315879]    = 'ClayHard',
    [2877802565]    = 'RoofFelt',
    [127813971]     = 'RockNoinst',
    [1639053622]    = 'Brick',
    [1109728704]    = 'MudDeep',
    [3545514974]    = 'WoodFloorDusty',
    [1907048430]    = 'PavingSlab',
    [937503243]     = 'GlassShootThrough',
    [2015599386]    = 'ConcretePavement',
    [2737678298]    = 'ClavicleRight',
    [122789469]     = 'Cloth',
    [1925605558]    = 'GravelTrainTrack',
    [223086562]     = 'Marsh',
    [3528912198]    = 'FiberglassHollow',
    [868733839]     = 'FreshMeat',
    [3210327185]    = 'ConcreteDusty',
    [2352068586]    = 'MudHard',
    [510490462]     = 'SandCompact',
    [1501078253]    = 'EmissiveGlass',
    [3511032624]    = 'RubberHollow',
    [2925830612]    = 'FootRight',
    [2461440131]    = 'Hay',
    [555004797]     = 'WoodSolidMedium',
    [2675173228]    = 'Perspex',
    [3124923563]    = 'PhysElectricFence',
    [2699818980]    = 'SandLoose',
    [2363942873]    = 'IceTarmac',
    [3154854427]    = 'Spine1',
    [3784624938]    = 'UpperArmLeft',
    [3834431425]    = 'ThighLeft',
    [752131025]     = 'MetalSolidLarge',
    [772722531]     = 'PlasticHollowClear',
    [13626292]      = 'Temp30',
    [1945073303]    = 'Marble',
    [2710969365]    = 'Temp15',
    [2206792300]    = 'StuntRampSurface',
    [4043078398]    = 'PlasterBrittle',
    [1345867677]    = 'PhysCarVoid',
    [2898482353]    = 'CarpetFloorboard',
    [2387446527]    = 'SandTrack',
    [2316997185]    = 'Temp02',
    [2281206151]    = 'PhysElectricMetal',
    [1429989756]    = 'TvScreen',
    [3720844863]    = 'PlasterSolid',
    [4170197704]    = 'RockMossy',
    [2519482235]    = 'Default',
    [2130571536]    = 'CarSoftTopClear',
    [5236042]       = 'Blood',
    [3674578943]    = 'Temp22',
    [1187676648]    = 'Concrete',
    [746881105]     = 'Temp01',
    [2573051366]    = 'CarGlassBulletproof',
    [765206029]     = 'Stone',
    [3115293198]    = 'Temp28',
    [889255498]     = 'Temp27',
    [1777921590]    = 'LowerArmRight',
    [1963820161]    = 'Temp24',
    [652772852]     = 'ShinLeft',
    [1755188853]    = 'RoofTile',
    [4021477129]    = 'MudUnderwater',
    [435688960]     = 'Water',
    [1176309403]    = 'WoodChipboard',
    [359120722]     = 'ConcretePothole',
    [762193613]     = 'MetalChainLinkSmall',
    [3008270349]    = 'GrassShort',
    [2409420175]    = 'DirtTrack',
    [576169331]     = 'Cobblestone',
    [3416406407]    = 'SnowCompact',
    [1354993138]    = 'Temp18',
    [1011960114]    = 'Temp17',
    [1952288305]    = 'Temp25',
    [1078418101]    = 'Temp29',
    [2011204130]    = 'WoodLattice',
    [1761524221]    = 'MetalDuct',
    [4149231379]    = 'Rubber',
    [3257211236]    = 'Temp21',
    [3848931141]    = 'ShinRight',
    [3158909604]    = 'SandUnderwater',
    [2657481383]    = 'Temp13',
    [1501153539]    = 'UpperArmRight',
    [1288448767]    = 'SandWetDeep',
    [2247498441]    = 'PhysDynamicCoverBound',
    [1886546517]    = 'TarmacPothole',
    [611561919]     = 'VfxMetalWaterTower',
    [2601153738]    = 'PhysGolfBall',
    [312396330]     = 'MudPothole',
    [4059664613]    = 'PhysCaster',
    [3603690002]    = 'VfxMetalSteam',
    [286224918]     = 'AnimalDefault',
    [4003336261]    = 'PhysPedCapsule',
    [2378027672]    = 'CarEngine',
    [2221655295]    = 'Plastic',
    [592446772]     = 'SandstoneSolid',
    [2016463089]    = 'PhysCasterRusty',
    [3315319434]    = 'CarSoftTop',
    [4057986041]    = 'ThighRight',
    [47470226]      = 'Temp11',
    [2000961972]    = 'HandRight',
    [332778253]     = 'VfxMetalFlame',
    [1911121241]    = 'Temp03',
    [1550304810]    = 'SnowTarmac',
    [3559574543]    = 'Head',
    [3539969597]    = 'MetalManhole',
    [125958708]     = 'MetalChainLinkLarge',
    [2529443614]    = 'Temp07',
    [3985833031]    = 'VfxMetalElectrified',
    [2956494126]    = 'PlasticHighDensityClear',
    [3147605720]    = 'BrickPavement',
    [3594309083]    = 'Soil',
    [32752644]      = 'Spine3',
    [722686013]     = 'WoodOldCreaky',
    [2847687191]    = 'MetalSolidSmall',
    [3369548007]    = 'WoodHollowLarge',
    [2993614768]    = 'TarmacPainted',
    [465002639]     = 'Temp23',
    [972939963]     = 'PhysPoolTableCushion',
    [605776921]     = 'PhysPoolTableSurface',
    [2100727187]    = 'MetalRailing',
    [1333033863]    = 'Grass',
    [2154880249]    = 'WoodHighFriction',
    [1247281098]    = 'CarGlassWeak',
    [244521486]     = 'GlassBulletproof',
    [834144982]     = 'MetalCorrugatedIron',
    [1341866303]    = 'FeatherPillow',
    [63305994]      = 'Temp10',
    [1913209870]    = 'SandstoneBrittle',
    [2782232023]    = 'Temp16',
    [2137197282]    = 'CarPlastic',
    [951832588]     = 'GravelSmall',
    [2660782956]    = 'Petrol',
    [1584636462]    = 'MarshDeep',
    [1635937914]    = 'MudSoft',
    [1441114862]    = 'BushesNoinst',
    [1061250033]    = 'Temp06',
    [1923995104]    = 'Temp04',
    [3493162850]    = 'Temp19',
    [1718294164]    = 'Neck',
    [1026054937]    = 'Temp09',
    [282940568]     = 'Tarmac',
    [1059629996]    = 'EmissivePlastic',
    [808719444]     = 'Foam',
    [581794674]     = 'Bushes',
    [3833216577]    = 'GrassLong',
    [3178714198]    = 'Temp26',
    [669292054]     = 'CarpetSolid',
    [627123000]     = 'PlasticHollow',
    [2357397706]    = 'SnowLoose',
    [3649011722]    = 'Temp14',
    [1845676458]    = 'Laminate',
    [2242086891]    = 'Temp20',
    [2538039965]    = 'Polystyrene',
    [3108646581]    = 'Ceramic',
    [15972667]      = 'MetalHollowSmall',
    [158576196]     = 'CarpetSolidDusty',
    [702596674]     = 'Temp12',
    [3895095068]    = 'WoodSolidSmall',
    [1500272081]    = 'GlassOpaque',
    [2253637325]    = 'Leaves',
    [4038262533]    = 'PhysTennisBall',
    [4063706601]    = 'MetalGarageDoor',
    [3711753465]    = 'MetalHollowLarge',
    [4044799021]    = 'RumbleStrip',
    [3565854962]    = 'MetalSolidRoadSurface',
    [1926285543]    = 'FootLeft',
    [673696729]     = 'SlattedBlinds',
    [1045062756]    = 'LowerArmLeft',
    [3508906581]    = 'Ice',
    [2435246283]    = 'PlasticClear',
    [289630530]     = 'Linoleum',
    [998201806]     = 'VfxWoodBeerBarrel',
    [3868849285]    = 'MetalGrille',
    [236511221]     = 'CardboardSheet',
    [2751643840]    = 'PhysBarbedWire',
    [560985072]     = 'ClaySoft',
    [2885912856]    = 'CardboardBox',
    [3340854742]    = 'BreezeBlock',
}

local wheeltypes 
local ignore      = false
local grounds     = Config.GroundTypes
local adjustments = Config.SpeedAdjustments

CreateThread(function()
    local playerPed
    local count
    while true do 
        local sleep = 1000
        playerPed   = playerPed or PlayerPedId()
        if IsPedSittingInAnyVehicle(playerPed) then 
            
            local vehicle       = GetVehiclePedIsIn(playerPed, false)
            
            local maxSpeed      = GetVehicleMaxSpeed(vehicle)
            local currentGround = GetGroundHash(vehicle)
            local groundType    = Config.Debug and materials[currentGround] or 'Not defined'
            local groundDebug   = Config.Debug and print('GroundHash =', currentGround, '/Type =', groundType)
            
            count = count or GetEntitySpeed(vehicle)
            
            if grounds[currentGround] and not ignored then 
                sleep = 100
                local currentClassId   = GetVehicleClass(vehicle)
                local currentClass     = getClass(vehicle, currentClassId)
                local currentWheeltype = getWheelType(GetVehicleWheelType(vehicle))
                
                local classMultiplier  = adjustments['classes'][currentClass] and adjustments['classes'][currentClass]['enable'] and adjustments['classes'][currentClass][grounds[currentGround]]
                local tireMultiplier   = adjustments['wheeltypes'][currentWheeltype] and adjustments['wheeltypes'][currentWheeltype]['enable'] and adjustments['wheeltypes'][currentWheeltype][grounds[currentGround]]
                local totalMultiplier  = classMultiplier and tireMultiplier and (classMultiplier+tireMultiplier) or classMultiplier

                if totalMultiplier then 
                    local groundMaxSpeed = (maxSpeed*(totalMultiplier < 1.0 and totalMultiplier or 1.0))

                    if count > groundMaxSpeed then 
                        count -= 1
                    elseif count < groundMaxSpeed then 
                        count += 1
                    end
                    SetVehicleMaxSpeed(vehicle, count)
                end
            else 
                SetVehicleMaxSpeed(vehicle, maxSpeed)
                count = nil
            end
        end
        Wait(sleep)
    end
end)

CreateThread(function()
    local playerPed
    while true do 
        local sleep = 1000
        playerPed = playerPed or PlayerPedId()
        local vehicle = GetVehiclePedIsIn(playerPed, false)
        for k, onList in pairs(Config.IgnoreVehicles) do 
            if onList then 
                ignore = true
            end
        end
        Wait(sleep)
    end

end)

function getWheelType(int)
    local types = {
        [-1] = 'stock',
        [0]  = 'sport',
        [1]  = 'muscle',
        [2]  = 'lowrider',
        [3]  = 'suv',
        [4]  = 'offroad',
        [5]  = 'tuner',
        [6]  = 'bike',
        [7]  = 'highend',
        [8]  = 'bennys_orig',
        [9]  = 'bennys_bes',
        [10] = 'open_wheel',
        [11] = 'street',
        [12] = 'unknown',
     
    }
    local type = int == -1 and nil or types[int]
    return type
end

function getClass(vehicle, int)
    local types = {
        [0]  = 'compacts',
        [1]  = 'sedans',
        [2]  = 'suvs',
        [3]  = 'coupes',
        [4]  = 'muscle',
        [5]  = 'sportsclassics',
        [6]  = 'sports',
        [7]  = 'super',
        [8]  = 'motorcycles',
        [9]  = 'offroad',
        [10] = 'industrial',
        [11] = 'utility',
        [12] = 'vans',
        [13] = 'cycles',
        [14] = 'boats',
        [15] = 'helicopters',
        [16] = 'planes',
        [17] = 'service',
        [18] = 'emergency',
        [19] = 'military',
        [20] = 'commercial',
        [21] = 'trains',
        [22] = 'openwheel',
    }
    local type = IsThisModelAJetski(GetEntityModel(vehicle)) and 'jetski' or IsThisModelAQuadbike(GetEntityModel(vehicle)) and 'quadbike' or types[int]
    return type 
end

function GetGroundHash(entity)
    local entityCoords = GetEntityCoords(entity)
    local num = StartShapeTestCapsule(entityCoords.x,entityCoords.y,entityCoords.z+4,entityCoords.x,entityCoords.y,entityCoords.z-2.0, 2, 1, entity, 7)
    local arg1, arg2, arg3, arg4, hash, args6 = GetShapeTestResultIncludingMaterial(num)
    -- print('hash',GetHashKey(0x8E4D8AFF), GetHashKey(hash))
    return hash
end

-- DEV TOOL -- 

-- local groundResults = {}

-- CreateThread(function()
--     local playerPed
--     while true do 
--         playerPed = playerPed or PlayerPedId()
--         -- print(GetGroundHash(playerPed))
--         Wait(1)
--         if IsControlJustPressed(0, 191) then 
--             groundResults[GetGroundHash(playerPed)] = materials[GetGroundHash(playerPed)] or 'NONE'
--             print(json.encode(groundResults, {indent = true}))
--             print(groundResults[GetGroundHash(playerPed)], materials[GetGroundHash(playerPed)], GetGroundHash(playerPed))
--         end
--     end
-- end)

-- RegisterCommand('groundresult', function()
--     TriggerServerEvent('format', groundResults)
-- end)



-- END OF DEV TOOL -- 
